version: '3'

networks:
  lyvely-network:
    driver: bridge

services:
  mongodb1:
    image: mongo:latest
    hostname: mongodb1
    user: "${MONGODB_USER}"
    networks:
      - lyvely-network
    container_name: lyvely-mongo1
    #environment:
    #  MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
    #  MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - ./data/mongo1:/data/db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-mongo1"
    depends_on:
      - api
      - mongodb2
      - mongodb3
    command: >
      mongod --replSet rs0 --port 27017 --dbpath /data/db & 
      sleep 5 && 
      mongosh --eval '
        config = {
          "_id" : "rs0",
          "members" : [
            {
              "_id" : 0,
              "host" : "mongodb1:27017"
            },
            {
              "_id" : 1,
              "host" : "mongodb2:27017"
            },
            {
              "_id" : 2,
              "host" : "mongodb3:27017"
            }
          ]
        };
        rs.initiate(config);
      '
    

  mongodb2:
    image: mongo:latest
    hostname: mongodb2
    user: "${MONGODB_USER}"
    networks:
      - lyvely-network
    container_name: lyvely-mongo2
    #environment:
    #  MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
    #  MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - ./data/mongo2:/data/db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-mongo2"
    depends_on:
      - api
    command: mongod --replSet rs0 --port 27017 --dbpath /data/db --oplogSize 128

  mongodb3:
    image: mongo:latest
    hostname: mongodb3
    user: "${MONGODB_USER}"
    networks:
      - lyvely-network
    container_name: lyvely-mongo3
    #environment:
    #  MONGO_INITDB_ROOT_USERNAME: root
    #  MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - ./data/mongo3:/data/db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-mongo3"
    depends_on:
      - api
    command: mongod --replSet rs0 --port 27017 --dbpath /data/db --oplogSize 128

  redis:
    image: redis:7.0.11-alpine
    hostname: redis
    user: "${REDIS_USER}"
    restart: always
    networks:
      - lyvely-network
    container_name: lyvely-redis
    #environment:
    #  REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-redis"
    command: redis-server --appendonly yes

  api:
    build:
      context: ../
      dockerfile: docker/Dockerfile
      target: api
    image: lyvely-api
    hostname: lyvely
    networks:
      - lyvely-network
    container_name: lyvely-api
    environment:
      NODE_ENV: production
    volumes:
      - ./config/lyvely.ts:/usr/src/app/packages/server/config/lyvely.ts:ro
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-api"

  frontend:
    build:
      context: ../
      dockerfile: docker/Dockerfile
      target: pwa
    image: lyvely-pwa
    networks:
      - lyvely-network
    hostname: nginx
    container_name: lyvely-pwa
    ports:
      - '${HTTP_PORT}:80'
      - "${HTTPS_PORT}:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "lyvely-pwa"
    depends_on:
      - api
